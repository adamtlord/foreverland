{% extends 'base_fidouche.html' %}
{% load custom_tags %}
{% load humanize %}
{% block content %}
<div class="page-header">
	<h2>Financial Reports</h2>
</div>
<form id="report_dates" role="form" action="">
	<div class="row">
		<div class="col-xs-4 col-sm-4 col-md-3 col-lg-2">
			<div class="form-group">
				<label class="sr-only" for="startDate">Start Date</label>
				<div class="input-group startDate">
					<input class="form-control" data-format="YYYY-MM-DD" id="start_date" name="start_date" type="text" placeholder="YYYY-MM-DD" {% if request.GET.start_date %}value="{{ request.GET.start_date }}"{% endif %}>
					<span class="input-group-addon">
						<i class="fa fa-calendar"></i>
					</span>
				</div>
				<span class="help-block">Need this.</span>
			</div>
		</div>
		<div class="col-xs-4 col-sm-4 col-md-3 col-lg-2">
			<div class="form-group">
				<label class="sr-only" for="endDate">End Date</label>
				<div class="input-group endDate">
					<input class="form-control" data-format="YYYY-MM-DD" id="end_date" name="end_date" type="text" placeholder="YYYY-MM-DD" {% if request.GET.end_date %}value="{{ request.GET.end_date }}"{% endif %}>
					<span class="input-group-addon">
						<i class="fa fa-calendar"></i>
					</span>
				</div>
				<span class="help-block">Need this.</span>
			</div>
		</div>
		<div class="col-xs-4 col-sm-4 col-md-3 col-lg-2">
			<button type="submit" class="btn btn-primary">Generate<span class="hidden-xs"> Reports</span></button>
		</div>
	</div>
	<hr />
</form>
{% if no_dates %}
	<p>Choose a date range</p>
{% else %}
	<ul class="nav nav-tabs">
		<li role="presentation" class="active"><a href="#members" data-toggle="tab">Members</a></li>
		<li role="presentation"><a href="#subs" data-toggle="tab">Subs</a></li>
		<li role="presentation"><a href="#expenses" data-toggle="tab">Expenses</a></li>
	</ul>
	<div class="tab-content">
		<div class="tab-pane active" id="members">
			<h3>Members</h3>
			<table class="table table-bordered table-striped datatable">
				<thead>
					<tr>
						<th>
							Member
						</th>
						<th>
							Total Paid
						</th>
						<th>
							Payments
						</th>
					</tr>
				</thead>
				<tbody>
					{% for member, payments in member_payments.items %}
						<tr>
							<td>{{ member }}</td>
							<td>${{ payments.total|intcomma }}</td>
							<td>{{ payments.payments|length }} {% if payments %}<i class="fa fa-list-ul payment-detail-toggle" data-toggle="collapse" data-target="#member{{ member.id }}_payments"></i>
								<table class="table table-condensed table-striped payment-details collapse" id="member{{ member.id }}_payments">
									<tbody>
										{% for payment in payments.payments %}
										<tr>
											<td>{{payment.show }}</td>
											<td>{{payment.amount }}</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>{% endif %}
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		<div class="tab-pane" id="subs">
			<h3>Subs</h3>
			<table class="table table-bordered table-striped datatable">
				<thead>
					<tr>
						<th>
							Sub
						</th>
						<th>
							Total Paid
						</th>
						<th>
							Payments
						</th>
					</tr>
				</thead>
				<tbody>
					{% for sub, payments in sub_payments.items %}
						<tr>
							<td>{{ sub }}</td>
							<td>${{ payments.total|intcomma }}</td>
							<td>{{ payments.payments|length }} {% if payments %}<i class="fa fa-list-ul payment-detail-toggle" data-toggle="collapse" data-target="#sub{{ sub.id }}_payments"></i>
								<table class="table table-condensed table-striped payment-details collapse" id="sub{{ sub.id }}_payments">
									<tbody>
										{% for payment in payments.payments %}
										<tr>
											<td>{{payment.show }}</td>
											<td>{{payment.amount }}</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>{% endif %}
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		<div class="tab-pane" id="expenses">
			<h3>Expenses</h3>
			<table class="table table-bordered table-striped datatable">
				<thead>
					<tr>
						<th>
							Payee
						</th>
						<th>
							Total Paid
						</th>
						<th>
							Payments
						</th>
					</tr>
				</thead>
				<tbody>
					{% for payee, payments in expense_payments.items %}
						<tr>
							<td>{{ payee }}</td>
							<td>${{ payments.total|intcomma }}</td>
							<td>{{ payments.payments|length }} {% if payments %}<i class="fa fa-list-ul payment-detail-toggle" data-toggle="collapse" data-target="#payee{{ payee.id }}_payments"></i>
								<table class="table table-condensed table-striped payment-details collapse" id="payee{{ payee.id }}_payments">
									<tbody>
										{% for payment in payments.payments %}
										<tr>
											<td>{{payment.date }}</td>
											<td>{{payment.category }}</td>
											<td>{{payment.amount }}</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>{% endif %}
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>

{% endif %}


{% endblock %}
{% block js %}
<script>
	$(function(){
		if(window.location.hash){
			var activeTab = window.location.hash;
			$('a[href="' + activeTab + '"]').tab('show');
		}
		$('a[data-toggle="tab"]').on('shown.bs.tab', function(e){
			window.location.hash = $(e.target).attr('href');
			e.preventDefault()
		});
		$('.startDate').datetimepicker({
			pickTime: false
		});
		$('.endDate').datetimepicker({
			pickTime: false,
			defaultDate: moment().format('YYYY-MM-DD')
		});
		$('#report_dates').submit(function(e){
			var sd = $('#start_date');
			var ed = $('#end_date');
			if(sd.val() == '' || ed.val() == ''){
				if(sd.val() == ''){
					sd.parents('.form-group').addClass('has-error');
				}
				if(ed.val() == ''){
					ed.parents('.form-group').addClass('has-error');
				}
				return false;
			}
		});
		$('.datatable').dataTable({
			"aaSorting": [ ],
			"aoColumnDefs": [
				{"sType": "currency", "aTargets": [2]}
			],
		});
	});
</script>
{% endblock %}
